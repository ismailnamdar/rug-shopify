<script src="{{ 'tinybind.js' | asset_url }}"></script>
<div class="mini-builder__container" id="mini-builder">
  <div class="mini-builder__background-container">
    <div class="mini-builder--bg-desktop hidden-mobile">
      {% render 'image', _image: section.settings.background_desktop, alt: section.settings.background_desktop.alt %}
    </div>
    <div class="mini-builder--bg-mobile hidden-desktop">
      {% render 'image', _image: section.settings.background_mobile, alt: section.settings.background_mobile.alt %}
    </div>
  </div>
  <div class="mini-builder__widget-container">
    <div class="widget-title"><h3 class="h3" {% if section.settings.header_color != blank %} style="color: {{section.settings.header_color}}" {% endif %} >{{section.settings.title}}</h3></div>
    <div class="widget-steps">
      <div class="widget-step widget-step--1">
        <p> {{section.settings.step_1_description}} </p>
        <h4 class="h4">{{section.settings.step_1_title}}</h4>
        <div class="widget-product-options">
          {% for block in section.blocks %}
            <div class="widget-option" rv-class-selected="state.selectedElementIndex | eq {{forloop.index0}}" data-index="{{forloop.index0}}" rv-on-click="methods.handleElementClick">
              <h5 class="h5">{{block.settings.product_title}}</h5>
              <p>{{block.settings.product_price}}</p>
              {% if block.settings.product_label != blank %}
              <p class="widget-label">{{block.settings.product_label}}</p>
              {% endif %}
            </div>
          {% endfor %}
          <div class="selection-marker" rv-data-selected="state.selectedElementIndex"> </div>
          {% if section.settings.free_gift_copy != blank %}
          <div class="free-gift-message">
            <span>
              {{section.settings.free_gift_copy}}
            </span>
          </div>
          {% endif %}
        </div>
      </div>
      <div class="widget-step widget-step--2" {% if section.settings.step_2_title == blank %} style="display: none" {% endif %}>
        <h4 class="h4">{{section.settings.step_2_title}}</h4>
        <p> {{section.settings.step_2_description}} </p>
        <button role="button" class="btn btn-o displayed" rv-class-displayed="state.noOfBundles | eq 0" rv-on-click="methods.toggleBundle">Add</button>
        <div class="quick-add-qty-container quick-add-qty-container--mini" rv-class-displayed="state.noOfBundles | eq 0 | not">
          <div class="quick-add-qty">
            <span class="quick-add-qty-minus" rv-on-click="methods.removeBundle">
              {% include 'icon-minus-qty' %}
            </span>
            <span class="quick-add-qty-display" rv-text="state.noOfBundles"></span>
            <span
              class="plan-switch-plus"
              rv-on-click="methods.addBundle"
              rv-if="state.noOfBundles | gte {{section.settings.max_siblings | json }} | not">
              {% include 'icon-plus-qty' %}
            </span>
            <span
              class="quick-add-qty-plus"
              rv-if="state.noOfBundles | gte {{section.settings.max_siblings | json }}"
              style="opacity: .4; pointer-events: none;">
              {% include 'icon-plus-qty' %}
            </span>
          </div>
        </div>
      </div>
      <div class="widget-autorenew-copy"> <i> *Membership auto-renews until cancelled </i> </div>
    </div>
    <div class="widget-add-to-cart 1">
      <button 
        class="btn btn--add-to-cart button-checkout"
        rv-on-click="methods.addToCart">
        <span class="checkout-loading"><img src="{{"loading-raddish.gif" | asset_img_url: "80x"}}" /></span>
        <span>Add to cart</span>
      </button>
    </div>
  </div>
</div>

<style>
  .quick-add-qty-container.quick-add-qty-container--mini {
    position: relative;
    left: 0;
    transform: none;
    padding: 0;
    display: none;
  }
  .quick-add-qty-container.quick-add-qty-container--mini.displayed {
    display: block
  }
  .quick-add-qty-container.quick-add-qty-container--mini .quick-add-qty{
    margin: 0;
  }
  .widget-product-options .widget-option .widget-label {
    position: absolute;
    top: 0;
    background: #9FCC57;
    padding: 4px 10px;
    border-radius: 3px;
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 600;
    transform: translateY(-50%);
  }
  div#mini-builder {
    padding: 70px 40px;
    max-width: 1380px;
    margin: 0 auto;
    position: relative;
  }

  .free-gift-message {
    position: absolute;
    right: {{100 | divided_by: section.blocks.size}}%;
    bottom: -25px;
    transform: translateX(50%);
    border: 1px solid pink;
    padding: 0px 30px;
    z-index: -1;
    border: 1px solid #4D4D4D33;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    border-top: 0;
    white-space: nowrap;
  }

  .free-gift-message span {
    background: white;
    transform: translateY(50%);
    display: block;
    font-weight: 900;
    font-size: 14px;
    color: #F3576B;
    padding-left: 5px;
    padding-right: 5px;
    text-align: center;
  }
  .mini-builder--bg-desktop img {
    max-width: 85%;
    width: 100%;
  }
  .widget-add-to-cart .btn:not(.loading) {
    width: 100%;
    padding: 17px 20px !important;
  }
  .widget-add-to-cart .btn.loading {
    width: 100%;
    padding: 2px 20px !important;
  }
  .mini-builder__widget-container {
    background: white;
    /* border: 1px solid pink; */
    border: 0.875px solid rgba(77, 77, 77, 0.19971);
    box-shadow: 0px 2px 4px rgba(77, 77, 77, 0.201868);
    border-radius: 8px;
    padding: 35px 55px;
    position: absolute;
    top: 50%;
    right: 0;
    transform: translate(0, -50%);
    width: 580px;
    max-width: 100%;
  }
  .widget-step .h4 {
    margin-bottom: 0;
    color: #4D4D4D;
    position: relative;
  }

  .widget-step p {
    margin-top: 0;
  }

  .widget-step--1 .h4:before {
    content: "1";
  }

  .widget-step--2 .h4:before {
    content: "2";
  }
  .widget-step.widget-step--2 .btn:not(.displayed) {
    display: none;
  }
  .widget-step.widget-step--2 .btn {
    width: 140px;
    background: white;
    color: #F3576B;
    border: 1px solid;
  }
  .template-page #MainContent .widget-step.widget-step--2 .btn {
    padding: 10px 20px 10px;
  }
  .widget-step--2 .btn.selected {
    font-size: 0;
  }
  .widget-step--2 .btn.selected:after {
    font-size: 16px;
    content: "Added!"
  }

  .widget-step.widget-step--2 .btn:hover,
  .widget-step.widget-step--2 .btn.selected {
    background: #F3576B;
    color: white;
    border: 1px solid #F3576B;
  }

  .widget-step {
    position: relative;
  }
  {% if section.settings.step_2_title == blank %}
  .widget-step.widget-step--1 h4 {
    margin-bottom: 2rem;
    margin-left: 4rem;
    display: flex;
    align-items: center;
  }
  {% endif %}
  {% if section.settings.step_2_title != blank %}
  .widget-steps {
    padding-left: 40px;
    margin-bottom: 2rem;
  }
  .widget-step.widget-step--1:before {
    content: "";
    position: absolute;
    width: 5px;
    height: 100%;
    left: -27px;
    background: #A9DD6166;
    transform: translateY(20px);
  }
  .widget-step.widget-step--1 {
    padding-bottom: 5rem;
  }
  {% endif %}
  .widget-step .h4:before {
    position: absolute;
    left: -40px;
    top: -4px;
    transform: translateY(0);
    background: #A9DD61;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50px;
    text-align: center;
  }
  .mini-builder__container .widget-product-options {
    margin-top: 22px;
  }
  .widget-product-options {
    display: flex;
    border: 0.875px solid rgba(77, 77, 77, 0.19971);
    border-radius: 8px;
    position: relative;
  }

  .widget-product-options .widget-option {
    flex: 1;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.75rem 0 1.25rem;
    z-index: 2;
    cursor: pointer;
  }
  .widget-option h5 {
    margin-bottom: 4px;
  }
  .widget-product-options .widget-option p {
    margin-bottom: 0;
  }
  .widget-product-options .selection-marker {
    position: absolute;
    width: {{ 100.0 | divided_by: section.blocks.size }}%;
    height: 100%;
    background: #E4F4F6;
    border: 1px solid #F3576B;
    border-radius: 10px;
    left: 0;
    transition: .3s ease-in;
  }
  {% for i in (0..5)%}
    .selection-marker[data-selected="{{i}}"] {
      left: {{100.0 | divided_by: section.blocks.size | round: 5 | times: i}}%;
    }
  {% endfor %}

  @media screen and (max-width: 749px) {
    .free-gift-message {
      padding: 0 16px;
    }
    .widget-step.widget-step--1:before {
      display:none
    }
    div#mini-builder {
      padding: 32px 18px;
    }
    .mini-builder__widget-container {
      position: relative;
      transform: none;
      padding: 14px 16px 30px;
      transform: translateY(-10px);
    }
    .widget-product-options {
      margin-left: -40px;
    }
    .widget-product-option .h5 {
      margin-bottom: 0;
    }
    .widget-title .h3 {
      text-align: center;
      font-size: 21px;
      max-width: 290px;
      position: relative;
      margin: 0 auto 2rem;
      border-bottom: 1px solid #4D4D4D32;
      padding-bottom: 1rem;
      padding-top: 1rem;
    }
    
    .mini-builder--bg-mobile.hidden-desktop {
      width: calc(100% - 30px);
      margin: 0 auto;
    }
  }
</style>


<script>
  class MiniBuilder {
    constructor(container, products) {
      this.$container = $(container);
      this.selectors = {
        addButton: this.$container.find('.btn--add-to-cart')
      }
      this.data = {
        products
      }
      this.cache = {}
      this.state = {
        touched: false,
        selectedElementIndex: 1,
        withBundle: false,
        noOfBundles: 0,
        activeStep: 1,
        modalOpen: false,
        buyNowShipLater: false,
        subscription: {
          club: "",
          plan_length: '',
        },
        parent: {
          first_name: '',
          last_name: '',
          email: ''
        },
        note: {{cart.note | json }},
        extraItems: {
          'sibling_bundle': '0'
        }
      }
      this.methods = {
        changeSelected: this.changeSelected.bind(this),
        handleElementClick: this.handleElementClick.bind(this),
        toggleBundle: this.toggleBundle.bind(this),
        addToCart: this.addToCart.bind(this),
        addBundle: this.addBundle.bind(this),
        removeBundle: this.removeBundle.bind(this)
      }
      this.ajaxCart = document.querySelector('ajax-cart');
      // if(this.customer.email) this.bindAbandonedEvents();
      // this.setState = this.setState
      this.setupFormatters()
      this.bindState();
    }

    findSelectedPlan() {
      if(!this.state.noOfBundles) return this.data.products[this.state.selectedElementIndex].product
      else return this.data.products[this.state.selectedElementIndex].sibling[`${this.state.noOfBundles}`]
    }

    generateHash(length) {
      var result = "";
      var timestamp = Date.now();
      var characters =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      var charactersLength = characters.length;
      for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      result += timestamp;
      return result;
    }
    addToCart() {
      console.log('adding to cart')
      this.selectors.addButton.addClass("loading")
      const plan = this.findSelectedPlan()
      const timestamp = new Date().getTime()
      const hash = this.generateHash(10);
      var properties = {
        // _activation_date: new Date().toLocaleString("en-US", {timeZone: "America/Los_Angeles"}).split(",")[0],
        _membership_timestamp: timestamp,
        // _subscription_id: plan.subscription_id,
        _subscription_hash: hash,
        // _subscription_item: plan.subscription_item,
        _plan: plan.plan,
      }
      var planItem =   {
        id: plan.id,
        quantity: 1,
        properties: properties,
        selling_plan: plan.selling_plan_id
      }
      var itemsToAdd = [planItem]
      console.log({itemsToAdd})
      if(plan.free_product) {
        itemsToAdd.push({
          id: plan.free_product,
          quantity: 1, 
          properties: {
            _is_gift_with_purchase: true,
            _membership_timestamp: timestamp,
            _gift_product: true,
            _required_products: plan.product_id
          }
        })
      }

      if(plan.free_product_2) {
        itemsToAdd.push({
          id: plan.free_product_2,
          quantity: 1, 
          properties: {
            _is_gift_with_purchase: true,
            _membership_timestamp: timestamp,
            _gift_product: true,
            _required_products: plan.product_id
          }
        })
      }

      if(plan.free_product_3) {
        itemsToAdd.push({
          id: plan.free_product_3,
          quantity: 1, 
          properties: {
            _is_gift_with_purchase: true,
            _membership_timestamp: timestamp,
            _gift_product: true,
            _required_products: plan.product_id
          }
        })
      }

      var self = this;
      
      if (this.state.note != '') {
        CartJS.setNote(this.state.note);
      }
      var totalNewItemsCount = itemsToAdd.length;
      var currentItemsCount = CartJS.cart.item_count;
      CartJS.addItems(itemsToAdd.reverse(), {
        "success": function(cartResponse) {
          console.log(cartResponse)
          fetch('/?sections=ajax-cart,cart-upsells')
            .then(response => response.json())
            .then((response) => {
              console.log(response)
              self.ajaxCart.renderContents({
                sections: {
                  'ajax-cart': response['ajax-cart'],
                  'selector': '#ajax-cart'
                }
              }, false);
              var currVal = $("#cart-icon-bubble-mobile span").text();
              var newVal =CartJS.cart.item_count;
              $("#cart-icon-bubble-mobile span").text(newVal);
              $("#cart-icon-bubble span").text(newVal);
              self.selectors.addButton.removeClass("loading")
              window.location.href = '/checkout'
              // setTimeout(() => {
               //  self.ajaxCart.open()
              // }, 100);
            })

        },
        "error": function(response) {
          console.log('error', response)
        }
      })
    }

    reChargeProcessCart() {
      window.location.href = '/checkout'
    }

    bindState() {
      tinybind.bind(this.$container, {
        state: this.state,
        methods: this.methods
      });
    }

    handleElementClick(event) {
      this.changeSelected(event.currentTarget.dataset.index)
    }

    changeSelected(selectedIndex) {
      this.state.selectedElementIndex = selectedIndex
    }

    toggleBundle() {
      this.state.noOfBundles = 1
    }
    addBundle() {
      this.state.noOfBundles++
    }
    removeBundle() {
      this.state.noOfBundles--
    }
    setupFormatters() {
      tinybind.formatters.args = function(fn) {
        let args = Array.prototype.slice.call(arguments, 1)
        return () => fn.apply(null, args)
      }
      tinybind.formatters.minus = function(e, t) {
        return parseInt(e) - parseInt(t)
      } 
      tinybind.formatters.times = function(e, t) {
        return e * t 
      }
      tinybind.formatters.log = function(value) {
        return value;
      };

      tinybind.formatters.log = function(value) {
        return value;
      };

      tinybind.formatters.size = function(value) {
        // console.log(value.length)
        return value.length;
      };

      tinybind.formatters.style = function(a, b) {
        return b + ': ' + a + ';'
      };

      tinybind.formatters.money = function(value) {
        return (parseFloat(value) / 100).toFixed(2).toString();
      };
      
      tinybind.formatters.not = function(value) {
        return !value;
      };

      tinybind.formatters.and = function(a, b) {
        return a && b;
      };

      tinybind.formatters.eq = function(a, b) {
        return a == b;
      };

      tinybind.formatters.gte = function(a, b) {
        return a >= b;
      };

      tinybind.formatters.gt = function(a, b) {
        return a > b;
      };

      tinybind.formatters.append = function(a, b) {
        return a + b;
      };
      tinybind.formatters.prepend = function(a, b) {
        return b + a;
      };
      tinybind.formatters.includes = function(array, value) {
        if(!array) return false
        return array.indexOf(value) > -1
      };
    }
  }
</script>

<script>
  var products = [
    {% for block in section.blocks %}
      {% assign main_product = all_products[block.settings.product] %}
      {% assign sibling_product = all_products[block.settings.product_with_sibling] %}
      {% assign sibling_product_2 = all_products[block.settings.product_with_sibling_2] %}
      {
        "product": {
          "id": {{ main_product.selected_or_first_available_variant.id | json }},
          "product_id": {{ main_product.product_id | json }},
          "subscription_id": {{main_product.metafields.subscriptions.subscription_id | json }},
          "shipping_interval_frequency": {{main_product.metafields.subscriptions.shipping_interval_frequency | json }},
          "shipping_interval_unit_type": {{main_product.metafields.subscriptions.shipping_interval_unit_type | json  }},
          "length": {{main_product.metafields.subscription.length | json }},
          "subscription_item": {{main_product.metafields.subscription.item | json }},
          "plan": {{main_product.metafields.subscription.plan | json }},
          "free_product": "{{main_product.metafields.subscription.free_product | split: "/" | last }}",
          "free_product_2": "{{main_product.metafields.subscription.free_product_2 | split: "/" | last }}",
          "free_product_3": "{{main_product.metafields.subscription.free_product_3 | split: "/" | last }}",
          "selling_plan_id": "{{ main_product.selling_plan_groups[0].selling_plans[0].id }}"
        },
        "sibling": {
          "1": {
            "id": {{ sibling_product.selected_or_first_available_variant.id | json }},
            "product_id": {{ sibling_product.product_id | json }},
            "subscription_id": {{sibling_product.metafields.subscriptions.subscription_id | json }},
            "shipping_interval_frequency": {{sibling_product.metafields.subscriptions.shipping_interval_frequency | json }},
            "shipping_interval_unit_type": {{sibling_product.metafields.subscriptions.shipping_interval_unit_type | json  }},
            "length": {{sibling_product.metafields.subscription.length | json }},
            "subscription_item": {{sibling_product.metafields.subscription.item | json }},
            "plan": {{sibling_product.metafields.subscription.plan | json }},
            "free_product": "{{sibling_product.metafields.subscription.free_product | split: "/" | last }}",
            "free_product_2": "{{sibling_product.metafields.subscription.free_product_2 | split: "/" | last }}",
            "free_product_3": "{{sibling_product.metafields.subscription.free_product_3 | split: "/" | last }}",
            "selling_plan_id": "{{ sibling_product.selling_plan_groups[0].selling_plans[0].id }}"
          },
          "2": {
            "id": {{ sibling_product_2.selected_or_first_available_variant.id | json }},
            "product_id": {{ sibling_product_2.product_id | json }},
            "subscription_id": {{sibling_product_2.metafields.subscriptions.subscription_id | json }},
            "shipping_interval_frequency": {{sibling_product_2.metafields.subscriptions.shipping_interval_frequency | json }},
            "shipping_interval_unit_type": {{sibling_product_2.metafields.subscriptions.shipping_interval_unit_type | json  }},
            "length": {{sibling_product_2.metafields.subscription.length | json }},
            "subscription_item": {{sibling_product_2.metafields.subscription.item | json }},
            "plan": {{sibling_product_2.metafields.subscription.plan | json }},
            "free_product": "{{sibling_product_2.metafields.subscription.free_product | split: "/" | last }}",
            "free_product_2": "{{sibling_product_2.metafields.subscription.free_product_2 | split: "/" | last }}",
            "free_product_3": "{{sibling_product_2.metafields.subscription.free_product_3 | split: "/" | last }}",
            "selling_plan_id": "{{ sibling_product_2.selling_plan_groups[0].selling_plans[0].id }}"
          }
        }
      }
      {% unless forloop.last%},{% endunless %}
    {% endfor %}
  ]

  document.addEventListener("DOMContentLoaded", function() {
    var theme = window.theme || {}
    theme.MiniBuilder = new MiniBuilder("#shopify-section-{{section.id}}", products);
  })
</script>

{% schema %}
{
  "name": "Mini Builder",
  "settings": [
    {
      "type": "image_picker",
      "id": "background_desktop",
      "label": "Background Desktop"
    },
    {
      "type": "image_picker",
      "id": "background_mobile",
      "label": "Background Mobile"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Get Cooking Today!"
    },
    {
      "type": "color",
      "id": "header_color",
      "label": "Header color"
    },
    {
      "type": "textarea",
      "id": "free_gift_copy",
      "label": "Free gift copy",
      "default": "+ Free Youth Apron!"
    },
    {
      "type": "text",
      "id": "step_1_title",
      "label": "Step 1 Title",
      "default": "Delivery Frequency:"
    },
    {
      "type": "textarea",
      "id": "step_1_description",
      "label": "Step 1 Description",
      "default": "Free US Shipping. First kit ships within 1-3 business days"
    },
    {
      "type": "text",
      "id": "step_2_title",
      "label": "Step 2 title",
      "default": "Sibling Bundle ($5/mo)"
    },
    {
      "type": "textarea",
      "id": "step_2_description",
      "label": "Step 2 Description",
      "default": "Add a sibling tool and patch to each kit"
    },
    {
      "type": "number",
      "id": "max_siblings",
      "label": "Max No of Sibling Bundles",
      "default": 2
    }
  ],
  "presets": [
    {
      "name": "Mini Builder",
      "category": "Subscription"
    }
  ],  
  "blocks": [
    {
      "type": "step_product",
      "name": "Step 1 Product",
      "settings": [
        {
          "type": "text",
          "id": "product_title",
          "label": "Title"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "product",
          "id": "product_with_sibling",
          "label": "Product with 1 bundle"
        },
        {
          "type": "product",
          "id": "product_with_sibling_2",
          "label": "Product with 2 bundles"
        },
        {
          "type": "text",
          "id": "product_price",
          "label": "Price"
        },
        {
          "type": "text",
          "id": "product_label",
          "label": "Label"
        }
      ]
    }
  ]
}
{% endschema %}
